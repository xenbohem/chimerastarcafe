<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Comfort Café | Chimera Grid</title>
<style>
  body{
    margin:0; padding:0;
    background:#0c0c12;
    font-family:"Poppins", sans-serif;
    color:white;
    display:flex;
    justify-content:center;
    align-items:center;
    height:100vh;
    overflow:hidden;
  }

  /* LOGIN */
  #loginScreen{position:absolute; inset:0; display:flex; justify-content:center; align-items:center; flex-direction:column; background:rgba(0,0,0,0.75); backdrop-filter:blur(8px); z-index:20; transition:0.4s;}
  #loginScreen input{padding:12px; border-radius:8px; border:none; margin:8px;}
  #loginScreen button{padding:10px 20px; border:none; border-radius:6px; background:#7a4bff; color:white; cursor:pointer;}

  /* GRID */
  #grid{display:grid; grid-template-columns:repeat(7,1fr); grid-template-rows:repeat(7,1fr); gap:6px; width:85vmin; height:85vmin; position:relative;}
  .tile{background:#1b1b25; border-radius:10px; display:flex; justify-content:center; align-items:center; cursor:pointer; transition:transform 0.35s ease, background 0.4s, box-shadow 0.4s; position:relative; overflow:hidden; opacity:0; transform:scale(0.6);}
  .tile.loaded{opacity:1; transform:scale(1);}
  .tile:hover{transform:scale(1.06); background:#252532; box-shadow:0 0 12px #7a4bff88;}

  .placeholder{width:80%; height:80%; background:#333; border-radius:8px; opacity:0.6;}

  /* POPUP */
  #overlay{position:fixed; inset:0; background:rgba(0,0,0,0.6); backdrop-filter:blur(4px); opacity:0; pointer-events:none; z-index:5; transition:0.3s;}
  #overlay.active{opacity:1; pointer-events:auto;}

  #popup{position:absolute; top:50%; left:50%; transform:translate(-50%,-50%) scale(0.7); opacity:0; background:#111; width:70vmin; padding:20px; border-radius:20px; box-shadow:0 0 40px rgba(255,255,255,0.1); z-index:50; transition:0.4s; pointer-events:none;}
  #popup.active{opacity:1; transform:translate(-50%,-50%) scale(1); pointer-events:auto;}
  #popup img{width:120px; height:120px; border-radius:12px; background:#444; margin-bottom:10px;}
  #popup button{margin-top:10px; padding:8px 16px; background:#7a4bff; border:none; border-radius:6px; color:white; cursor:pointer;}

  /* VIDEO */
  #videoContainer{position:absolute; top:0; left:0; width:100%; height:100%; display:flex; justify-content:center; align-items:center; pointer-events:none; opacity:0; transition:opacity 1s ease;}
  #videoContainer.fade-in{opacity:1; pointer-events:auto;}
  #videoContainer video{max-width:80%; max-height:80%; border-radius:12px;}

  /* CODEX */
  #codexBtn{position:fixed; top:10px; right:10px; z-index:30; padding:10px 16px; border:none; border-radius:6px; background:#7a4bff; cursor:pointer;}
  .codexEntry{margin-bottom:12px; border-bottom:1px solid #444; padding-bottom:8px;}
  .codexEntry img{width:60px; height:60px; border-radius:8px; display:block; margin-bottom:4px;}
  .badge{display:inline-block; background:#7a4bff; color:white; padding:4px 10px; border-radius:8px; margin-top:6px; font-size:0.8em;}

/* CODEX STYLES START */
#codex {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 80%;
  max-height: 70vh;
  overflow-y: auto;
  background: rgba(20, 20, 30, 0.8);
  backdrop-filter: blur(6px);
  border: 2px solid rgba(255, 255, 255, 0.3);
  border-radius: 16px;
  padding: 20px;
  display: none;
  z-index: 9999;
  box-shadow: 0 0 20px rgba(180, 120, 255, 0.4);
  color: #fff;
}

.codex-entry {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px;
  margin-bottom: 8px;
  background: rgba(255,255,255,0.06);
  border-radius: 10px;
  transition: 0.3s ease;
}

.codex-entry.completed {
  background: rgba(120,255,120,0.15);
  box-shadow: 0 0 10px rgba(120,255,120,0.3);
}

.codex-entry.incomplete::after {
  content: "Incomplete";
  color: #aaa;
  font-style: italic;
}

.codex-entry.completed::after {
  content: "✔ Completed";
  color: #7cff7c;
  font-weight: bold;
}
/* CODEX STYLES END */

</style>
</head>
<body>

<div id="loginScreen">
  <h2>Enter the Café</h2>
  <input id="userInput" placeholder="Username" />
  <button id="loginBtn">Enter</button>
</div>

<div id="grid"></div>
<div id="popup"></div>
<div id="overlay"></div>
<div id="videoContainer"><video id="characterVideo" src="character_intro.mp4" muted></video></div>
<audio id="mikiTrack" src="cafespiritpulse.mp3"></audio>
<button id="codexBtn">Codex</button>

<script>
document.addEventListener("DOMContentLoaded",()=>{
  const grid=document.getElementById('grid');
  const popup=document.getElementById('popup');
  const overlay=document.getElementById('overlay');
  const loginScreen=document.getElementById('loginScreen');
  const video=document.getElementById('characterVideo');
  const videoContainer=document.getElementById('videoContainer');
  const mikiTrack=document.getElementById('mikiTrack');

  const characters={
    star:{name:"Star",img:"placeholder_star.png",text:"I’m Star — born in mythic Mini-Paris...",quiz:"Why did Yeshua give me the Café?",answer:"freedom",badge:"Star Insight"},
    hans:{name:"Hans",img:"placeholder_hans.png",text:"Former vampire — now a connoisseur...",quiz:"What city are we really from?",answer:"mini-paris",badge:"Tea Scholar"},
    chari:{name:"Chari",img:"placeholder_chari.png",text:"I’m Chari… rat-cat hybrid...",quiz:"Who rescued us?",answer:"yeshua",badge:"Courage Seed"},
    milo:{name:"Milo",img:"placeholder_milo.png",text:"I tend the herb gardens...",quiz:"My role in Café’s peace?",answer:"gardener",badge:"Peacekeeper"},
    miki:{name:"Miki",img:"placeholder_miki.png",text:"Yo, welcome! Frequencies...",quiz:"Where did we escape from?",answer:"lab",music:true,badge:"Frequency Adept"}
  };

  const codex=JSON.parse(localStorage.getItem('chimeraCodex'))||[];
  const badges=JSON.parse(localStorage.getItem('chimeraBadges'))||[];

  function awardBadge(b){if(!badges.includes(b)){badges.push(b);localStorage.setItem('chimeraBadges',JSON.stringify(badges));}}

  function collectCodexEntry(title,desc,img,type){
    if(!codex.some(e=>e.title===title)){
      codex.push({title,desc,img,type});
      localStorage.setItem('chimeraCodex',JSON.stringify(codex));
    }
  }

  function openCodex(){
    let html=`<h2>Codex</h2>`;
    codex.forEach(e=>{
      html+=`<div class='codexEntry'>${e.img?`<img src='${e.img}'/>`:''}<h3>${e.title}</h3><p>${e.desc}</p></div>`;
    });
    html+=`<h3>Badges</h3>`;
    badges.forEach(b=> html+=`<span class='badge'>${b}</span>`);
    html+=`<br><button id='closePopupBtn'>Close</button>`;
    popup.innerHTML=html;
    popup.classList.add('active'); overlay.classList.add('active');
    document.getElementById('closePopupBtn').onclick=closePopup;
  }
  document.getElementById('codexBtn').onclick=openCodex;

  function createGrid(){
    grid.innerHTML='';
    for(let i=0;i<49;i++){
      const tile=document.createElement('div'); tile.className='tile';
      setTimeout(()=>tile.classList.add('loaded'),i*25);
      if(i%2===0){let keys=Object.keys(characters); tile.dataset.type='character'; tile.dataset.char=keys[Math.floor(Math.random()*keys.length)];}
      else tile.dataset.type='lore';
      if(i===10) tile.dataset.portal='hans';
      if(i===24) tile.dataset.portal='yeshua';
      if(i===40) tile.dataset.portal='miki';
      tile.innerHTML="<div class='placeholder'></div>";
      tile.onclick=()=>handleTile(tile);
      grid.appendChild(tile);
    }
  }

  function handleTile(t){
    if(t.dataset.portal) return openPortal(t.dataset.portal);
    if(t.dataset.type==='character') return openCharacter(t.dataset.char);
    if(t.dataset.type==='lore') return openLore();
  }

  function openCharacter(id){
    const c=characters[id];
    let quizHTML=`<input id='quizInput' placeholder='Answer...' /><button id='quizBtn'>Submit</button>`;

    popup.innerHTML=`<img src='${c.img}'/><h2>${c.name}</h2><p>${c.text}</p><p><em>${c.quiz}</em></p>${quizHTML}<button id='closePopupBtn'>Close</button>`;

    popup.classList.add('active'); overlay.classList.add('active');

    collectCodexEntry(c.name,c.text,c.img,'character');

    if(c.music){mikiTrack.play(); videoContainer.classList.add('fade-in'); video.play();}
    else{mikiTrack.pause(); mikiTrack.currentTime=0;}

    document.getElementById('closePopupBtn').onclick=closePopup;
    document.getElementById('quizBtn').onclick=()=>{
      let val=document.getElementById('quizInput').value.toLowerCase();
      if(val.includes(c.answer)){
        awardBadge(c.badge);
        document.getElementById('quizBtn').innerText="✓ Correct! Badge Unlocked";
      } else {
        document.getElementById('quizBtn').innerText="Try Again";
      }
    };
  }

  function openLore(){
    const lore=["Mini-Paris was built inside a dream dimension.","Faint violin music echoes...","The Café walls shift...","A rat scurries by...","A warm presence fills the air..."];
    const text=lore[Math.floor(Math.random()*lore.length)];
    popup.innerHTML=`<h2>Mystery Fragment</h2><p>${text}</p><button id='closePopupBtn'>Close</button>`;
    popup.classList.add('active'); overlay.classList.add('active');
    collectCodexEntry('Mystery Fragment',text,'','lore');
    document.getElementById('closePopupBtn').onclick=closePopup;
  }

  function openPortal(key){
    if(key==='hans') return openCharacter('hans');
    if(key==='miki') return openCharacter('miki');
    if(key==='yeshua') return openYeshua();
  }

  function openYeshua(){
    popup.innerHTML=`<h2 style='color:#ffeaae; text-shadow:0 0 20px #fff]>Eternal Light</h2><p>You step into a warm, ethereal glow...</p><button id='closePopupBtn'>Return</button>`;
    popup.classList.add('active'); overlay.classList.add('active');
    awardBadge("Light Touched");
    document.getElementById('closePopupBtn').onclick=closePopup;
  }

  function closePopup(){popup.classList.remove('active'); overlay.classList.remove('active');}

  document.getElementById('loginBtn').onclick=()=>{loginScreen.style.opacity=0; setTimeout(()=>{loginScreen.style.display='none'; createGrid();},400);} 

  video.addEventListener('loadeddata',()=> videoContainer.classList.add('fade-in'));
});

/* CODEX LOGIC START */
let codexData = JSON.parse(localStorage.getItem('codexData') || '{}');

function markCodexComplete(id) {
  codexData[id] = true;
  localStorage.setItem('codexData', JSON.stringify(codexData));
  updateCodexDisplay();
}

function updateCodexDisplay() {
  const codexList = document.getElementById('codex-list');
  if (!codexList) return;
  codexList.innerHTML = '';

  Object.keys(characterLore).forEach(key => {
    const entry = document.createElement('div');
    entry.className = 'codex-entry ' + (codexData[key] ? 'completed' : 'incomplete');
    entry.innerHTML = `<span>${characterLore[key].name}</span>`;
    codexList.appendChild(entry);
  });
}

function openCodex() {
  const c = document.getElementById('codex');
  updateCodexDisplay();
  c.style.display = 'block';
}

function closeCodex() {
  document.getElementById('codex').style.display = 'none';
}
/* CODEX LOGIC END */

</script>
</body>
</html>
