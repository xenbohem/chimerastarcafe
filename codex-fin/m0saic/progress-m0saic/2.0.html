<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Comfort Café | Chimera Grid</title>
<style>
  body{margin:0;padding:0;background:#0c0c12;font-family:"Poppins",sans-serif;color:white;overflow:hidden;}
  /* LOGIN OVERLAY */
  #loginScreen{position:fixed;inset:0;background: rgba(0,0,0,0.8);display:flex;justify-content:center;align-items:center;z-index:1000;}
  #loginCard{background:#1b0b2f;padding:30px;border-radius:16px;box-shadow:0 0 40px rgba(255,255,255,0.2);display:flex;flex-direction:column;align-items:center;}
  #loginCard input{padding:12px;border-radius:8px;border:none;margin:8px 0;width:200px;text-align:center;}
  #loginCard button{padding:10px 20px;margin:0 5px;border:none;border-radius:8px;background:#7a4bff;color:white;cursor:pointer;}
  #loginCard button:hover{background:#9a6fff;}
  /* GRID */
  #grid{display:grid;grid-template-columns:repeat(7,1fr);grid-template-rows:repeat(7,1fr);gap:6px;width:80vmin;height:80vmin;margin:auto;}
  .tile{background:#1b1b25;border-radius:10px;display:flex;justify-content:center;align-items:center;cursor:pointer;transition:transform 0.3s ease, background 0.4s, box-shadow 0.4s;position:relative;overflow:hidden;opacity:0;}
  .tile:hover{transform:scale(1.05);background:#252532;box-shadow:0 0 12px #7a4bff;}
  .placeholder{width:80%;height:80%;background:#333;border-radius:8px;opacity:0.6;}
  /* POPUP */
  #overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);backdrop-filter:blur(4px);opacity:0;pointer-events:none;z-index:500;transition:0.3s ease;}
  #overlay.active{opacity:1;pointer-events:auto;}
  #popup{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%) scale(0.7);opacity:0;background:#111;width:70vmin;padding:20px;border-radius:20px;box-shadow:0 0 40px rgba(255,255,255,0.1);z-index:1000;transition:0.4s ease;pointer-events:none;}
  #popup.active{opacity:1;transform:translate(-50%,-50%) scale(1);pointer-events:auto;}
  #popup img{width:120px;height:120px;border-radius:12px;background:#444;margin-bottom:10px;}
  #popup button{margin-top:10px;padding:8px 16px;background:#7a4bff;border:none;border-radius:6px;color:white;cursor:pointer;}
  /* VIDEO */
  #videoContainer{position:absolute;top:0;left:0;width:100%;height:100%;display:flex;justify-content:center;align-items:center;pointer-events:none;opacity:0;transition:opacity 1s ease;}
  #videoContainer.fade-in{opacity:1;pointer-events:auto;}
  #videoContainer video{max-width:80%;max-height:80%;border-radius:12px;}
  /* CODEX */
  #codexBtn{position:fixed;top:10px;right:10px;z-index:1100;padding:10px 16px;border:none;border-radius:6px;background:#7a4bff;cursor:pointer;}
  #codexPopup{position:fixed;top:10%;left:50%;transform:translateX(-50%);width:60vmin;max-height:80vh;background:#1b0b2f;border-radius:16px;padding:20px;overflow-y:auto;box-shadow:0 0 40px rgba(255,255,255,0.2);z-index:1200;display:none;}
  .codexEntry{margin-bottom:12px;border-bottom:1px solid #444;padding-bottom:8px;}
  .codexEntry img{width:60px;height:60px;border-radius:8px;display:block;margin-bottom:4px;}
  /* TIMER RING */
  .timerRing{position:absolute;top:10px;right:10px;width:40px;height:40px;border-radius:50%;border:3px solid #7a4bff;box-sizing:border-box;}
  .timerRing svg{transform:rotate(-90deg);}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginScreen">
  <div id="loginCard">
    <h2>Enter the Café</h2>
    <input type="text" id="userInput" placeholder="Username" />
    <div style="margin-top:10px;">
      <button id="enterBtn">Enter</button>
      <button id="guestBtn">Guest</button>
    </div>
  </div>
</div>

<!-- GRID -->
<div id="grid"></div>

<!-- POPUPS -->
<div id="overlay"></div>
<div id="popup"></div>
<div id="videoContainer"><video id="characterVideo" src="character_intro.mp4" muted></video></div>
<audio id="mikiTrack" src="cafespiritpulse.mp3" controls style="position:fixed;bottom:10px;left:10px;z-index:1100;"></audio>
<button id="codexBtn">Codex</button>
<div id="codexPopup"></div>

<script>
document.addEventListener('DOMContentLoaded',()=>{
  const loginScreen=document.getElementById('loginScreen');
  const userInput=document.getElementById('userInput');
  const enterBtn=document.getElementById('enterBtn');
  const guestBtn=document.getElementById('guestBtn');
  const grid=document.getElementById('grid');
  const popup=document.getElementById('popup');
  const overlay=document.getElementById('overlay');
  const videoContainer=document.getElementById('videoContainer');
  const video=document.getElementById('characterVideo');
  const mikiTrack=document.getElementById('mikiTrack');
  const codexBtn=document.getElementById('codexBtn');
  const codexPopup=document.getElementById('codexPopup');

  let codex=JSON.parse(localStorage.getItem('chimeraCodex')||'[]');
  let autoCloseTimer=null;
  let lastMouseMove=Date.now();

  const characters={
    star:{name:"Star",img:"placeholder_star.png",text:"I’m Star — born in mythic Mini-Paris. Yeshua saved us after the lab escape. Now I run this Café.",quiz:"Why did Yeshua give me the Café?"},
    hans:{name:"Hans",img:"placeholder_hans.png",text:"Former vampire — now a connoisseur of life & tea. Romans says the gift of God is eternal life… which is superior to undeath.",quiz:"What city are we really from, dear patron?"},
    chari:{name:"Chari",img:"placeholder_chari.png",text:"I’m Chari… rat-cat hybrid. I still get scared. But Yeshua saved me. Milo helps me breathe again.",quiz:"Who rescued us from the lab?"},
    milo:{name:"Milo",img:"placeholder_milo.png",text:"I tend the herb gardens of Mini-Paris. Taoism taught me flow; Yeshua taught me freedom.",quiz:"What role do I play in the Café’s peace?"},
    miki:{name:"Miki",img:"placeholder_miki.png",text:"Yo, welcome! My frequencies are portals. Track auto-plays — vibe with it.",quiz:"Where did we escape from? (Hint: a lab)",music:true}
  };

  const portals={hansPortal:"hans",yeshuaPortal:"yeshua",mikiPortal:"miki"};

  function saveCodex(){localStorage.setItem('chimeraCodex',JSON.stringify(codex));}

  function collectCodex(title,desc,img,type){
    if(!codex.some(e=>e.title===title)){
      codex.push({title,desc,img,type,unlocked:true});
      saveCodex();
    }
  }

  function openCodex(){
    codexPopup.innerHTML='';
    if(codex.length===0){codexPopup.innerHTML='<p>No entries yet.</p>';}
    codex.forEach(e=>{
      const div=document.createElement('div');
      div.className='codexEntry';
      if(e.img)div.innerHTML=`<img src="${e.img}">`;
      div.innerHTML+=`<h3>${e.title}</h3><p>${e.desc}</p>`;
      codexPopup.appendChild(div);
    });
    codexPopup.style.display='block';
  }

  codexBtn.addEventListener('click',()=>codexPopup.style.display==='block'?codexPopup.style.display='none':openCodex());

  function createGrid(){
    grid.innerHTML='';
    for(let i=0;i<49;i++){
      const tile=document.createElement('div');
      tile.className='tile';
      tile.dataset.index=i;
      if(i%2===0){
        const keys=Object.keys(characters);
        tile.dataset.type="character";
        tile.dataset.char=keys[Math.floor(Math.random()*keys.length)];
      } else tile.dataset.type="lore";
      if(i===5)tile.dataset.portal="hansPortal";
      if(i===13)tile.dataset.portal="yeshuaPortal";
      if(i===27)tile.dataset.portal="mikiPortal";
      const ph=document.createElement('div'); ph.className='placeholder';
      tile.appendChild(ph);
      tile.addEventListener('click',handleTileClick);
      grid.appendChild(tile);
      setTimeout(()=>tile.style.opacity=1, i*50); // animated entrance
    }
  }

  function handleTileClick(){
    const portal=this.dataset.portal;
    const type=this.dataset.type;
    const who=this.dataset.char;
    if(portal) return openPortal(portal);
    if(type==='character') return openCharacter(who);
    if(type==='lore') return openLore();
  }

  function openCharacter(id){
    const c=characters[id]; if(!c)return;
    popup.innerHTML=`<img src="${c.img}"><h2>${c.name}</h2><p>${c.text}</p><p><em>${c.quiz}</em></p>${c.music?`<br><button onclick="toggleMusic()">Play/Pause Music</button>`:''}<br><button id="closeBtn">Close</button>`;
    popup.classList.add('active'); overlay.classList.add('active');
    collectCodex(c.name,c.text,c.img,'character');
    document.getElementById('closeBtn').onclick=closePopup;
    startAutoClose();
  }

  function toggleMusic(){
    if(mikiTrack.paused)mikiTrack.play();
    else mikiTrack.pause();
  }

  function openLore(){
    const loreArr=["Mini-Paris was built inside a dream dimension.","You hear faint violin music… someone remembers a past life.","The Café walls shift when truth is spoken.","A rat scurries by — Chari’s support companion.","You sense Yeshua’s gentle presence."];
    const lore=loreArr[Math.floor(Math.random()*loreArr.length)];
    popup.innerHTML=`<h2>Mystery Fragment</h2><p>${lore}</p><button id="closeBtn">Close</button>`;
    popup.classList.add('active'); overlay.classList.add('active');
    collectCodex('Mystery Fragment',lore,'','lore');
    document.getElementById('closeBtn').onclick=closePopup;
    startAutoClose();
  }

  function openPortal(key){
    if(key==='hansPortal') return openCharacter('hans');
    if(key==='mikiPortal') return openCharacter('miki');
    if(key==='yeshuaPortal') return openYeshua();
  }

  function openYeshua(){
    popup.innerHTML=`<h2 style="color:#ffeaae;text-shadow:0 0 20px #fff6c8">Eternal Light</h2><p>You step into a soft, ethereal glow. Yeshua's presence feels like warm dawn.<br><br>Romans reminds you: <em>“Whoever calls on the name of the Lord shall be saved.”</em></p><button id="closeBtn">Return</button>`;
    popup.classList.add('active'); overlay.classList.add('active');
    collectCodex('Yeshua','Soft ethereal presence and teaching.','','yeshua');
    document.getElementById('closeBtn').onclick=closePopup;
    startAutoClose();
  }

  function closePopup(){
    popup.classList.remove('active');
    overlay.classList.remove('active');
    clearTimeout(autoCloseTimer);
  }

  function startAutoClose(){
    clearTimeout(autoCloseTimer);
    autoCloseTimer=setTimeout(closePopup,7000);
  }

  // Auto-close if mouse inactive for 7s
  document.addEventListener('mousemove',()=>{lastMouseMove=Date.now();});
  setInterval(()=>{
    if(popup.classList.contains('active') && Date.now()-lastMouseMove>7000){
      closePopup();
    }
  },1000);

  // LOGIN HANDLERS
  function finishLogin(name){
    if(!name||name.trim()===''){alert('Enter a username or click Guest'); return;}
    console.log("Logged in as:",name);
    loginScreen.style.display='none';
    createGrid();
  }
  enterBtn.addEventListener('click',()=>finishLogin(userInput.value));
  guestBtn.addEventListener('click',()=>finishLogin('Guest'));
  userInput.addEventListener('keydown',e=>{if(e.key==='Enter')finishLogin(userInput.value);});
});
</script>
</body>
</html>
