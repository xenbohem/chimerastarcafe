<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Chimera CafÃ© â€” Patched Full Build</title>
<style>
:root{ --bg:#0c0c12; --panel:#12061a; --accent:#7a4bff; --accent-2:#9a6fff; --completed:#8a6be6; --muted:#cfc7e8; --codex-width:360px; --countdown-circ:440; }
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0; min-height:100vh; background:linear-gradient(180deg,var(--bg), #161226 86%); color:#fff; font-family:Inter, system-ui, -apple-system; display:flex; align-items:center; justify-content:center; padding:20px;}
.wrap{ width:min(1200px,96vw); max-width:1200px; position:relative; }
header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:14px; gap:12px; }
h1{ margin:0; color:var(--muted); font-weight:600; font-size:1.05rem; }
/* Buttons */
.btn{ padding:10px 14px; background:var(--accent); border:none; border-radius:8px; color:#fff; cursor:pointer; font-size:.95rem; }
.btn.ghost{ background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.12); }
.iconBtn{ position:fixed; width:46px; height:46px; border-radius:10px; display:flex; align-items:center; justify-content:center; background:linear-gradient(180deg, rgba(122,75,255,0.16), rgba(122,75,255,0.08)); color:white; border:1px solid rgba(255,255,255,0.04); cursor:pointer; z-index:16000; box-shadow:0 8px 30px rgba(122,75,255,0.08); }
#restartBtn{ left:16px; top:16px; } #codexToggle{ right:16px; top:16px; }
.hud{ display:flex; gap:12px; align-items:center; color:var(--muted); font-weight:600; }
/* Grid */
#grid{ display:grid; grid-template-columns:repeat(7,1fr); gap:10px; width:min(84vmin,900px); aspect-ratio:1/1; perspective:1000px; }
.tile{ background:linear-gradient(180deg,#1b1622,#181022); border-radius:12px; display:flex; align-items:center; justify-content:center; transition:transform .28s, box-shadow .28s, background .28s, opacity .28s; cursor:pointer; position:relative; overflow:visible; min-height:0; }
.tile:hover{ transform: translateY(-6px) scale(1.03); box-shadow: 0 18px 60px rgba(122,75,255,0.08); }
.stub{ width:82%; height:82%; border-radius:8px; background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); display:flex; align-items:center; justify-content:center; font-family:Georgia,serif; font-weight:700; color:#fff; text-align:center; padding:8px; }
.tile.completed{ background: linear-gradient(180deg,var(--completed), #6f49d9); box-shadow:0 20px 50px rgba(111,73,217,0.18); transform:none; animation:completedPulse .9s ease; }
@keyframes completedPulse{ 0%{ transform:scale(1.02);} 50%{ transform:scale(1);} 100%{ transform:scale(1.01);} }
.tile.portal.yeshua::after{ content:""; position:absolute; inset:0; pointer-events:none; box-shadow: inset 0 0 40px rgba(255,240,200,0.06), 0 8px 40px rgba(200,160,255,0.03); border-radius:12px; }
/* halo ring for portal */
.haloRing{ position:absolute; top:-8px; left:-8px; width:calc(100% + 16px); height:calc(100% + 16px); pointer-events:none; }
.haloRing svg{ width:100%; height:100%; transform:rotate(-90deg); }
.haloGlow{ filter:drop-shadow(0 0 8px var(--accent)) drop-shadow(0 0 16px var(--accent-2)); }
/* overlay & modal */
#overlay{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.6); z-index:15000; }
#overlay.active{ display:flex; }
.modal{ width:min(920px,94%); max-height:86vh; overflow:auto; background:linear-gradient(180deg,#110617,#1a0f2b); padding:18px; border-radius:12px; box-shadow:0 20px 80px rgba(0,0,0,0.6); color:#fff; position:relative; }
.row{ display:flex; gap:14px; align-items:flex-start; }
.left{ width:140px; flex:0 0 140px; }
.bigPortrait{ width:140px; height:140px; border-radius:10px; background:#221132; display:flex; align-items:center; justify-content:center; font-family:Georgia,serif; font-weight:700; }
/* countdown */
.countdownWrap{ position:absolute; right:18px; top:18px; width:70px; height:70px; z-index:2000; pointer-events:none; display:flex; align-items:center; justify-content:center; }
.countdownSVG{ width:86%; height:86%; transform:rotate(-90deg); }
.countdownCircle{ fill:none; stroke:rgba(255,255,255,0.03); stroke-width:6; }
.countdownRing{ fill:none; stroke:var(--accent); stroke-width:6; stroke-linecap:round; stroke-dasharray: var(--countdown-circ); stroke-dashoffset: 0; }
.countdownLabel{ position:absolute; right:28px; top:26px; font-size:12px; color:var(--muted); pointer-events:none; }
/* codex drawer */
#codexPanel{ position:fixed; right:0; top:0; height:100vh; width:var(--codex-width); background:linear-gradient(180deg,#1b0b2f,#241235); box-shadow:-20px 0 60px rgba(0,0,0,0.6); transform:translateX(100%); transition:transform .45s cubic-bezier(.2,.9,.25,1); z-index:17000; padding:12px; overflow:auto; }
#codexPanel.open{ transform:translateX(0); }
.codex-header{ display:flex; justify-content:space-between; align-items:center; gap:12px; }
.codex-list{ margin-top:12px; display:flex; flex-direction:column; gap:8px; }
.codex-item{ padding:10px; background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:8px; display:flex; gap:12px; align-items:center; }
.codex-item.completed{ border-left:4px solid #7cff7c; opacity:0.95; }
.codex-item img{ width:64px; height:64px; border-radius:8px; }
.badge-gallery{ margin-top:12px; display:flex; gap:8px; flex-wrap:wrap; }
.badgeSmall{ width:64px;height:64px;border-radius:12px;background:linear-gradient(180deg,#7a4bff,#9a6cff);display:flex;align-items:center;justify-content:center;color:#fff;margin:6px;cursor:pointer; }
/* responsive */
@media (max-width:900px){ #codexPanel{ width:86vw; } .left{ display:none; } .bigPortrait{ width:100%; height:120px; margin-bottom:8px; } }
</style>
</head>
<body>
  <div class="wrap" aria-live="polite">
    <header>
      <h1>Comfort CafÃ© â€” Mini-Paris</h1>
      <div style="display:flex;align-items:center;gap:12px;">
        <div class="hud"><div id="scoreDisplay">Score: 0</div><div id="badgeCount" style="opacity:0.9">Badges: 0</div></div>
        <button id="logoutBtn" class="btn ghost" style="display:none;margin-left:8px;">Logout</button>
      </div>
    </header>

    <main>
      <div id="grid" aria-label="Chimera grid"></div>
    </main>
  </div>

  <div id="restartBtn" class="iconBtn" title="Restart progress">â†»</div>
  <div id="codexToggle" class="iconBtn" title="Open Codex">ðŸ“–</div>

  <!-- Login overlay -->
  <div id="loginOverlay" role="dialog" aria-modal="true" style="display:flex; align-items:center; justify-content:center; inset:0; position:fixed; z-index:18000; background:linear-gradient(180deg, rgba(0,0,0,0.86), rgba(0,0,0,0.9));">
    <div class="loginCard" style="width:420px; background:linear-gradient(180deg,#1b0f2b,#241235); padding:22px; border-radius:12px; text-align:center; box-shadow:0 40px 120px rgba(0,0,0,0.6);">
      <h2 style="font-family:Georgia, serif; margin:0 0 6px 0;">Enter the CafÃ©</h2>
      <input id="usernameInput" placeholder="Your name (or Guest)" style="width:88%; padding:10px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background:rgba(0,0,0,0.08); color:#fff" />
      <div style="margin-top:12px; display:flex; gap:8px; justify-content:center;">
        <button id="loginEnterBtn" class="btn">Enter</button>
        <button id="loginGuestBtn" class="btn ghost">Guest</button>
      </div>
      <p style="margin-top:10px;color:var(--muted);font-size:0.88rem;">Progress is saved locally in this browser.</p>
    </div>
  </div>

  <!-- Overlay & modal -->
  <div id="overlay" role="dialog" aria-hidden="true">
    <div class="modal" id="modalBox" role="document"></div>
  </div>

  <!-- Codex drawer -->
  <aside id="codexPanel" aria-hidden="true" aria-label="Codex drawer">
    <div class="codex-header">
      <h3 style="margin:0;">Codex</h3>
      <div style="display:flex;gap:8px;align-items:center;">
        <button id="closeCodex" class="btn ghost">Close</button>
      </div>
    </div>
    <div class="codex-list" id="codexList"></div>
    <hr style="opacity:0.06;margin:12px 0;">
    <div><strong>Badges</strong></div>
    <div class="badge-gallery" id="badgeGallery"></div>
  </aside>

  <!-- Miki audio -->
  <audio id="mikiAudio" src="cafespiritpulse.mp3"></audio>

<script>
document.addEventListener('DOMContentLoaded', ()=>{
  // Elements
  const grid = document.getElementById('grid');
  const loginOverlay = document.getElementById('loginOverlay');
  const usernameInput = document.getElementById('usernameInput');
  const loginEnterBtn = document.getElementById('loginEnterBtn');
  const loginGuestBtn = document.getElementById('loginGuestBtn');
  const overlay = document.getElementById('overlay');
  const modalBox = document.getElementById('modalBox');
  const codexPanel = document.getElementById('codexPanel');
  const codexToggle = document.getElementById('codexToggle');
  const closeCodexBtn = document.getElementById('closeCodex');
  const codexList = document.getElementById('codexList');
  const badgeGallery = document.getElementById('badgeGallery');
  const restartBtn = document.getElementById('restartBtn');
  const mikiAudio = document.getElementById('mikiAudio');
  const scoreDisplay = document.getElementById('scoreDisplay');
  const badgeCount = document.getElementById('badgeCount');
  const logoutBtn = document.getElementById('logoutBtn');

  // Config
  const GRID_SIZE = 7; const TOTAL = GRID_SIZE*GRID_SIZE; const AUTO_CLOSE_MS = 25000; const COUNTDOWN_CIRC = 440;
  const STORAGE = { CODEX:'chimera_codex_vBplus', COMPLETED:'chimera_completed_vBplus', SCORE:'chimera_score_vBplus', BADGES:'chimera_badges_vBplus', USER:'chimera_user_vBplus' };

  // State
  let codex = JSON.parse(localStorage.getItem(STORAGE.CODEX) || '[]');
  let completed = JSON.parse(localStorage.getItem(STORAGE.COMPLETED) || '{}');
  let score = Number(localStorage.getItem(STORAGE.SCORE) || 0);
  let badges = JSON.parse(localStorage.getItem(STORAGE.BADGES) || '[]');
  let username = localStorage.getItem(STORAGE.USER) || '';

  function updateHUD(){ scoreDisplay.textContent = `Score: ${score}`; badgeCount.textContent = `Badges: ${badges.length}`; }
  updateHUD();

  // Characters & mapping
  const CHARACTERS = {
    star:{key:'star',name:'Star',img:'placeholder_star.png',lore:`I remember the cold hum of the glass cage â€” the lab lights, the clicks... We were lifted like fish in a warm current. Yeshua carried us into a garden paradise. â€” Star` , answer:'freedom'},
    hans:{key:'hans',name:'Hans',img:'placeholder_hans.png',lore:`Hans the tea-brewer, once a wry street fox. He loves strong tea and stranger jokes.`, answer:'mini-paris'},
    chari:{key:'chari',name:'Chari',img:'placeholder_chari.png',lore:`Chari found a tiny brass key and wouldn't stop humming.`, answer:'yeshua'},
    milo:{key:'milo',name:'Milo',img:'placeholder_milo.png',lore:`Milo tends the herb shelves with a gardener's patience.`, answer:'gardener'},
    miki:{key:'miki',name:'Miki',img:'placeholder_miki.png',lore:`Miki was small and bright and trembling â€” but she bolted. The portal opened and the rest is music.`, answer:'lab', music:true }
  };
  const PORTALS = { hans:6, yeshua:20, miki:42 };

  const esc = s => String(s||'').replace(/[&<>'"`]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',"'":'&#39;','`':'&#96;'}[m]));

  // Persistence helper
  function saveAll(){ localStorage.setItem(STORAGE.CODEX, JSON.stringify(codex)); localStorage.setItem(STORAGE.COMPLETED, JSON.stringify(completed)); localStorage.setItem(STORAGE.SCORE, String(score)); localStorage.setItem(STORAGE.BADGES, JSON.stringify(badges)); localStorage.setItem(STORAGE.USER, username); updateHUD(); }

  // Map tile
  function mapTile(i){
    if(i===PORTALS.hans) return { type:'portal', id:'portal_hans', title:'Hans Portal', desc:CHARACTERS.hans.lore, img:CHARACTERS.hans.img };
    if(i===PORTALS.miki) return { type:'portal', id:'portal_miki', title:'Miki Portal', desc:CHARACTERS.miki.lore, img:CHARACTERS.miki.img };
    if(i===PORTALS.yeshua) return { type:'portal', id:'portal_yeshua', title:'Yeshua', desc:CHARACTERS.star.lore, img:'' };
    if(i%2===0){ const keys=Object.keys(CHARACTERS); const char=CHARACTERS[keys[(i/2)%keys.length]]; return { type:'character', id:`char_${char.key}_${i}`, title:char.name, desc:char.lore, img:char.img, key:char.key, answer:char.answer, music:(char.music||false) } }
    const loreArr=[ 'Mini-Paris was stitched from moonlight and cobblestone.', 'A faded lab token reads: "Atelier â€” experimental wing."', 'The CafÃ© floor sometimes remembers old songs.', 'A rat leaves a tiny key behind â€” Chari notices it.', 'Milo hums to the herbs; they unfurl like memories.' ];
    return { type:'lore', id:`lore_${i}`, title:'Mystery Fragment', desc:loreArr[i%loreArr.length], img:'' };
  }

  // Create grid
  function createGrid(){ grid.innerHTML=''; for(let i=0;i<TOTAL;i++){ const tile=document.createElement('div'); tile.className='tile'; tile.dataset.index=i; const mapping=mapTile(i); const stub=document.createElement('div'); stub.className='stub'; stub.textContent = mapping.title; tile.appendChild(stub); if(mapping.type==='portal') addHaloRing(tile); if(completed[i]) tile.classList.add('completed'); tile.addEventListener('click', ()=> onTileClick(i)); tile.style.opacity=0; tile.style.transform='translateY(18px) scale(.98)'; setTimeout(()=>{ tile.style.opacity=1; tile.style.transform='translateY(0) scale(1)'; }, 60 + i*18); grid.appendChild(tile); } }

  // Halo ring per portal (SVG countdown ring)
  function addHaloRing(tile){ if(tile.querySelector('.haloRing')) return; const wrap=document.createElement('div'); wrap.className='haloRing'; wrap.innerHTML = `<svg class="haloGlow" viewBox="0 0 150 150"><circle cx="75" cy="75" r="70" stroke="var(--accent)" stroke-width="4" fill="none" stroke-dasharray="440" stroke-dashoffset="440"></circle></svg>`; tile.appendChild(wrap); }

  // Modal + countdown control
  let popupActive=false; let currentPopup=null; let autoCloseTimeout=null; let countdownRAF=null; let countdownStart=0; let countdownTotal=AUTO_CLOSE_MS;

  function openModal(html, { tileIndex=null, replayable=false, disableAutoClose=false }={}){
    closeModal({ markCompleted:false }); modalBox.innerHTML = html; overlay.classList.add('active'); popupActive=true; currentPopup={ tileIndex, replayable };
    if(!disableAutoClose) startCountdown(AUTO_CLOSE_MS);
  }

  function closeModal({ markCompleted=true }={}){ stopCountdown(); overlay.classList.remove('active'); modalBox.innerHTML=''; popupActive=false; if(markCompleted && currentPopup && currentPopup.tileIndex!=null && !currentPopup.replayable){ completed[currentPopup.tileIndex]=true; finalizeCodexForTile(currentPopup.tileIndex); awardBadge(`tile_${currentPopup.tileIndex}`, `Tile ${currentPopup.tileIndex}`, `Completed tile ${currentPopup.tileIndex}`); saveAll(); const tileEl=document.querySelector(`.tile[data-index="${currentPopup.tileIndex}"]`); if(tileEl) tileEl.classList.add('completed'); } currentPopup=null; }

  overlay.addEventListener('click', (e)=>{ if(e.target===overlay) closeModal(); }); document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'&&popupActive) closeModal(); });

  function createCountdownUI(){ if(modalBox.querySelector('.countdownWrap')) return; const wrap=document.createElement('div'); wrap.className='countdownWrap'; wrap.innerHTML=`<svg class="countdownSVG" viewBox="0 0 150 150"><circle class="countdownCircle" cx="75" cy="75" r="70"></circle><circle class="countdownRing" cx="75" cy="75" r="70" stroke-dasharray="${COUNTDOWN_CIRC}" stroke-dashoffset="0"></circle></svg><div class="countdownLabel" aria-hidden="true">25s</div>`; modalBox.appendChild(wrap); // pause on hover
    modalBox.addEventListener('mouseenter', pauseCountdown); modalBox.addEventListener('mouseleave', resumeCountdown); modalBox.addEventListener('mousemove', resetAutoCloseTimer); modalBox.addEventListener('keydown', resetAutoCloseTimer); modalBox.addEventListener('click', resetAutoCloseTimer); }

  function startCountdown(ms){ stopCountdown(); createCountdownUI(); countdownStart = performance.now(); countdownTotal = ms; const ring = modalBox.querySelector('.countdownRing'); const label = modalBox.querySelector('.countdownLabel'); function tick(now){ const elapsed = now - countdownStart; const pct = Math.min(1, elapsed / countdownTotal); const offset = COUNTDOWN_CIRC * pct; if(ring) ring.style.strokeDashoffset = offset; if(label) label.textContent = `${Math.max(0, Math.ceil((countdownTotal - elapsed)/1000))}s`; if(elapsed >= countdownTotal){ closeModal({ markCompleted:true }); return; } countdownRAF = requestAnimationFrame(tick); } countdownRAF = requestAnimationFrame(tick); autoCloseTimeout = setTimeout(()=>{ closeModal({ markCompleted:true }); }, ms + 60); }
  function stopCountdown(){ if(countdownRAF) cancelAnimationFrame(countdownRAF); countdownRAF=null; if(autoCloseTimeout){ clearTimeout(autoCloseTimeout); autoCloseTimeout=null; } const wrap=modalBox.querySelector('.countdownWrap'); if(wrap) wrap.remove(); modalBox.removeEventListener('mouseenter', pauseCountdown); modalBox.removeEventListener('mouseleave', resumeCountdown); }
  function pauseCountdown(){ if(countdownRAF) { cancelAnimationFrame(countdownRAF); countdownRAF=null; if(autoCloseTimeout){ clearTimeout(autoCloseTimeout); autoCloseTimeout=null; } } }
  function resumeCountdown(){ const ring = modalBox.querySelector('.countdownRing'); if(!ring) return; // compute elapsed from dashoffset
    const offset = parseFloat(ring.style.strokeDashoffset || 0); const pct = Math.min(1, offset / COUNTDOWN_CIRC); const elapsed = pct * countdownTotal; countdownStart = performance.now() - elapsed; startCountdown(countdownTotal - elapsed); }
  function resetAutoCloseTimer(){ if(!popupActive) return; startCountdown(AUTO_CLOSE_MS); }

  // Codex & badges
  function refreshCodexPanel(){ codexList.innerHTML=''; if(codex.length===0) codexList.innerHTML = '<p style="opacity:.9">No entries yet â€” explore tiles to unlock the Codex.</p>'; codex.slice().reverse().forEach(e=>{ const div=document.createElement('div'); div.className='codex-item'+(e.completed? ' completed':''); if(e.img) div.innerHTML = `<img src="${esc(e.img)}" alt="">`; div.innerHTML += `<div style="flex:1"><strong>${esc(e.title)}</strong><div style="opacity:.9">${esc(e.desc)}</div></div>`; codexList.appendChild(div); }); badgeGallery.innerHTML=''; if(badges.length===0) badgeGallery.innerHTML = '<div style="opacity:.9">No badges yet</div>'; badges.forEach(b=>{ const d=document.createElement('div'); d.className='badgeSmall'; d.title = b.title; d.textContent = b.title[0]||'B'; d.addEventListener('click', ()=> openBadgePreview(b)); badgeGallery.appendChild(d); }); }

  codexToggle.addEventListener('click', ()=>{ if(codexPanel.classList.contains('open')){ codexPanel.classList.remove('open'); codexPanel.setAttribute('aria-hidden','true'); } else { refreshCodexPanel(); codexPanel.classList.add('open'); codexPanel.setAttribute('aria-hidden','false'); } });
  closeCodexBtn.addEventListener('click', ()=>{ codexPanel.classList.remove('open'); codexPanel.setAttribute('aria-hidden','true'); });

  function openBadgePreview(b){ const html = `<h2>${esc(b.title)}</h2><div style="display:flex;gap:12px;align-items:center"><div style="width:180px;height:180px;border-radius:12px;background:#221132;display:flex;align-items:center;justify-content:center;font-weight:700">${esc(b.title)}</div><div><p>${esc(b.desc)}</p><p style="opacity:.9">Unlocked: ${new Date(b.when).toLocaleString()}</p></div></div><div style="text-align:right;margin-top:12px"><button data-close="popup" class="btn">Close</button></div>`; openModal(html, { disableAutoClose:true }); }

  function ensureCodexEntry(id,title,desc,img=''){ if(!codex.some(e=>e.id===id)){ codex.push({ id,title,desc,img,completed:false,when:Date.now() }); saveAll(); showFly('Codex +1'); return true; } return false; }
  function finalizeCodexForTile(tileIndex){ const mapping = mapTile(tileIndex); if(!mapping) return; const idx = codex.findIndex(e=>e.id===mapping.id); if(idx>=0){ codex[idx].completed = true; codex[idx].when = Date.now(); saveAll(); } else { codex.push({ id:mapping.id, title:mapping.title, desc:mapping.desc, img:mapping.img||'', completed:true, when:Date.now() }); saveAll(); } }
  function awardBadge(id,title,desc=''){ if(!badges.some(b=>b.id===id)){ badges.push({ id,title,desc,img:'',when:Date.now() }); saveAll(); showFly(title); } }
  function showFly(text='Unlocked'){ const el=document.createElement('div'); el.className='flyBadge'; el.style.cssText = 'position:fixed;right:22px;top:22px;background:var(--accent);color:#fff;padding:10px 14px;border-radius:999px;z-index:20000;animation:flyIn 900ms cubic-bezier(.2,.9,.3,1);box-shadow:0 10px 30px rgba(122,75,255,0.18);'; el.textContent=text; document.body.appendChild(el); setTimeout(()=>el.remove(),2400); }

  // Character modals and quizzes
  function openCharacterModal(tileIndex,key){ const mapping = mapTile(tileIndex); ensureCodexEntry(mapping.id,mapping.title,mapping.desc,mapping.img||''); const char = CHARACTERS[key] || { name:mapping.title, answer:'' }; const musicHtml = (char.music) ? `<div style="margin-top:10px"><button id="mikiPlayBtn" class="btn">Play/Pause</button> <a href="cafespiritpulse.mp3" download class="btn ghost" style="margin-left:8px">Download</a></div>` : ''; const html = `<div class="row"><div class="left"><div class="bigPortrait">${esc(mapping.title)}</div></div><div style="flex:1"><h2>${esc(mapping.title)}</h2><p>${esc(mapping.desc)}</p><p style="opacity:.9;margin-top:6px">Quick quiz â€” short answer:</p><div style="margin-top:8px"><input id="quizInput" placeholder="Your answer..." style="padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);width:60%;background:transparent;color:#fff"> <button id="quizSubmit" class="btn">Submit</button></div>${musicHtml}<div style="text-align:right;margin-top:12px"><button data-close="popup" class="btn">Close</button></div></div></div>`; openModal(html, { tileIndex, replayable:false, disableAutoClose:false }); setTimeout(()=>{ const submitBtn=document.getElementById('quizSubmit'); const input=document.getElementById('quizInput'); if(submitBtn && input){ submitBtn.onclick = ()=>{ const ans=(input.value||'').trim().toLowerCase(); const expected=(char && char.answer)? String(char.answer).toLowerCase():''; const correct = expected && ans.includes(expected); if(correct){ score += 10; awardBadge(`badge_${key}`, `${char.name} Badge`, `Answered about ${char.name}.`); finalizeCodexForTile(tileIndex); saveAll(); openModal(`<h2>Correct!</h2><p>You gained 10 points and a badge (if new). Entry saved to Codex.</p><div style="text-align:right;margin-top:12px"><button data-close="popup" class="btn">Close</button></div>`, { tileIndex, replayable:false }); completed[tileIndex]=true; const tileEl=document.querySelector(`.tile[data-index="${tileIndex}"]`); if(tileEl) tileEl.classList.add('completed'); saveAll(); } else { submitBtn.textContent='Try again'; setTimeout(()=>submitBtn.textContent='Submit',900); } }; } const playBtn=document.getElementById('mikiPlayBtn'); if(playBtn) playBtn.onclick = ()=>{ if(mikiAudio.paused) mikiAudio.play().catch(()=>{}); else mikiAudio.pause(); }; },40); }

  function openLoreModal(tileIndex){ const mapping = mapTile(tileIndex); ensureCodexEntry(mapping.id,mapping.title,mapping.desc,mapping.img||''); openModal(`<h2>${esc(mapping.title)}</h2><p>${esc(mapping.desc)}</p><div style="text-align:right;margin-top:12px"><button data-close="popup" class="btn">Close</button></div>`, { tileIndex, replayable:false, disableAutoClose:false }); }

  function openYeshuaModal(tileIndex){ ensureCodexEntry('yeshua','Yeshua','Soft ethereal presence and Romans (Romans 10:13).',''); openModal(`<h2 style="color:#ffeaae">Eternal Light</h2><p>You step into a soft, ethereal glow. Romans: <em>"Whoever calls on the name of the Lord shall be saved."</em></p><div style="text-align:right;margin-top:12px"><button data-close="popup" class="btn">Return</button></div>`, { tileIndex, replayable:false, disableAutoClose:false }); }

  // Star origin story
  function openBoxOneStory(tileIndex){ const storyHtml = `<div style="padding:6px 4px"><h2>Star â€” The Awakening</h2><p style="line-height:1.45">I remember the cold hum of the glass cage â€” the lab lights, the clicks. They picked us up from an adoption agency and took us to a place that said "progress" but felt like a cage. The scientists wanted to see whether we could think like them, whether we could mimic a human heart.</p><p style="line-height:1.45">We were there one year and seven days. On that last day, the scientists whispered about discarding Miki. She was small and bright and trembling â€” but at the exact moment the glass was unlocked, she bolted. And then â€” like a thief in the night â€” Yeshua appeared.</p><p style="line-height:1.45">There was a BOOM, a sound wave that washed the lab in light. The portal opened. Hans â€” once a vampire fox-cat â€” yowled as something inside him broke free. It wasn't pain; it was the first breath of love. The scientists fell to their knees, blinded by the light.</p><p style="line-height:1.45">We were lifted like fish in a warm current. Yeshua carried us through the roof into a garden paradise, where the smell of fresh coffee and herbs filled the air, brewed by angels. We didn't die â€” we were more alive than ever. We had been granted a new realm, a home between the old world and this new paradise. That is the birth of the Chimera Cat CafÃ©.</p><p style="line-height:1.45"><em>â€” Star</em></p><div style="text-align:center;margin-top:12px"><button id="storyCompleteBtn" class="btn">I witnessed the Awakening</button> <button data-close="popup" class="btn ghost">Close</button></div></div>`; openModal(storyHtml, { tileIndex, replayable:false, disableAutoClose:false }); setTimeout(()=>{ const completeBtn = document.getElementById('storyCompleteBtn'); if(completeBtn){ completeBtn.onclick = ()=>{ awardBadge('liberated_soul','Liberated Soul','Witnessed the birth of the CafÃ©.'); ensureCodexEntry('origin_story','The Awakening','Star recounts the escape and the arrival in the Garden-CafÃ©.'); completed[tileIndex]=true; const tileEl=document.querySelector(`.tile[data-index="${tileIndex}"]`); if(tileEl) tileEl.classList.add('completed'); saveAll(); openModal(`<h2>Achievement Unlocked</h2><p><strong>Liberated Soul</strong> â€” You witnessed the birth of the CafÃ© and earned a badge.</p><div style="text-align:right;margin-top:12px"><button data-close="popup" class="btn">Nice</button></div>`, { disableAutoClose:false }); }; } },40); }

  // Restart
  restartBtn.addEventListener('click', ()=>{ const ok = confirm('Restart progress? This will clear Codex, badges, scores and completed tiles. Your username will remain. Continue?'); if(!ok) return; codex=[]; completed={}; score=0; badges=[]; saveAll(); document.querySelectorAll('.tile').forEach(t=>t.classList.remove('completed')); refreshCodexPanel(); updateHUD(); showFly('Progress reset'); });

  // Delegated close
  document.addEventListener('click', (e)=>{ const btn = e.target.closest('[data-close="popup"]'); if(btn){ closeModal({ markCompleted:true }); saveAll(); refreshCodexPanel(); } });

  // Badge preview exists earlier

  // Tile click handling
  function onTileClick(i){ const mapping = mapTile(i); if(completed[i]){ openModal(`<h2>Already done</h2><p>This tile is completed.</p><div style="text-align:right;margin-top:12px"><button data-close="popup" class="btn">Close</button></div>`, { tileIndex:i, replayable:false }); return; } if(mapping.type==='portal'){ if(mapping.id==='portal_hans') openCharacterModal(i,'hans'); else if(mapping.id==='portal_miki') openCharacterModal(i,'miki'); else if(mapping.id==='portal_yeshua') openYeshuaModal(i); return; } if(mapping.type==='character') openCharacterModal(i,mapping.key||mapping.title.toLowerCase()); if(mapping.type==='lore') openLoreModal(i); }

  // Startup
  function startApp(){ createGrid(); setTimeout(()=>{ if(!completed[0]) openBoxOneStory(0); refreshCodexPanel(); },420); }

  // Login handlers
  loginEnterBtn.addEventListener('click', ()=>{ const name = usernameInput.value.trim(); if(!name){ alert('Please enter a name or click Guest'); return; } username = name; localStorage.setItem(STORAGE.USER, username); loginOverlay.style.display='none'; logoutBtn.style.display='inline-flex'; startApp(); });
  loginGuestBtn.addEventListener('click', ()=>{ username='Guest'; usernameInput.value='Guest'; localStorage.setItem(STORAGE.USER, username); loginOverlay.style.display='none'; logoutBtn.style.display='inline-flex'; startApp(); });
  usernameInput.addEventListener('keydown',(e)=>{ if(e.key==='Enter') loginEnterBtn.click(); });

  // Logout
  logoutBtn.addEventListener('click', ()=>{ localStorage.removeItem(STORAGE.USER); username=''; loginOverlay.style.display='flex'; usernameInput.focus(); logoutBtn.style.display='none'; });

  // Auto-login
  if(localStorage.getItem(STORAGE.USER)){ username = localStorage.getItem(STORAGE.USER); loginOverlay.style.display='none'; logoutBtn.style.display='inline-flex'; startApp(); } else { loginOverlay.style.display='flex'; usernameInput.focus(); }

  // Expose minimal API for debugging
  window.Chimera = { saveAll, openModal, closeModal, codex, completed, badges, score };
});
</script>
</body>
</html>
